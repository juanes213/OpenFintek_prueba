<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waver - Asistente Virtual</title>
    <link rel="stylesheet" href="/static/css/style.css?v={{ v }}">
        <style id="live-overrides">
            /* Fuerza cambios visibles aunque el CSS externo esté en caché */
            /* (sin overrides sobre .input-container para que el rectángulo se muestre) */
            .app-container .chat-container input#messageInput { outline: none !important; }

            /* Usuario: 'Tú' arriba, a la derecha; hora pegada bajo burbuja a la derecha */
            .user-message .message-header { margin-bottom: 0 !important; justify-content: flex-end !important; text-align: right !important; }
            .user-message .message-time { margin-top: 0 !important; text-align: right !important; padding-right: 0.5rem !important; align-self: flex-end !important; width: auto !important; }
            .user-bubble-row { align-items: center !important; }
            .user-bubble-col { align-items: flex-end !important; width: fit-content !important; }

            /* Bot: sin espacio entre 'Waver' y hora */
            .bot-message .message-header { margin-bottom: 0 !important; }
        </style>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Meta información para SEO y redes sociales -->
    <meta name="description" content="Waver - Asistente virtual para consultas de e-commerce, pedidos, productos y soporte al cliente">
    <meta name="author" content="E-commerce Chatbot">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph para compartir -->
    <meta property="og:title" content="Waver - Asistente Virtual E-commerce">
    <meta property="og:description" content="Chat inteligente para consultas de pedidos, productos y soporte">
    <meta property="og:type" content="website">
    
    <!-- Configuración de PWA -->
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Waver Chatbot">
</head>
<body>
    <div class="app-container minimal">
        <aside class="sidebar minimal" role="navigation" aria-label="Navegación principal">
            <div class="sidebar-header minimal">
                <div class="logo minimal">
                    <svg id="waverLogo" class="waver-logo" width="40" height="40" viewBox="0 0 100 100" aria-label="Waver Avatar">
                        <!-- Avatar animado se insertará aquí -->
                    </svg>
                    <span class="logo-text">Waver</span>
                </div>
            </div>
            <nav class="sidebar-nav minimal" role="menu">
                <button class="nav-item active minimal" data-section="chat" role="menuitem" aria-current="page" aria-label="Conversación actual">
                    <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M8 12H8.01M12 12H12.01M16 12H16.01M21 12C21 16.418 16.97 20 12 20C10.5 20 9.07 19.62 7.79 18.96L3 20L4.24 15.62C3.5 14.34 3 12.72 3 12C3 7.582 7.03 4 12 4C16.97 4 21 7.582 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Conversación</span>
                </button>
                <button class="nav-item minimal" data-section="history" role="menuitem" aria-label="Ver historial de conversaciones">
                    <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 8V12L15 15M21 12C21 16.97 16.97 21 12 21C7.03 21 3 16.97 3 12C3 7.03 7.03 3 12 3C16.97 3 21 7.03 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Historial</span>
                </button>
                    <!-- Configuración oculta por solicitud -->
            </nav>
            <div class="sidebar-footer minimal">
                <button class="nav-item minimal" id="clearChatBtn" aria-label="Iniciar nueva conversación">
                    <svg class="nav-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M19 7L18.133 19.142C18.08 19.938 17.454 20.574 16.657 20.627L16.5 20.634H7.5C6.669 20.634 5.959 20.004 5.875 19.176L5 7M10 11V17M14 11V17M15 7V4C15 3.448 14.552 3 14 3H10C9.448 3 9 3.448 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Nuevo</span>
                </button>
            </div>
        </aside>
        <main class="main-content minimal" role="main" aria-label="Área de conversación">
            <div class="chat-container minimal">
                <div class="chat-messages" id="chatMessages" role="log" aria-live="polite" aria-label="Historial de conversación">
                    <!-- Welcome Message -->
                    <div class="message-group bot-group" role="article" aria-label="Mensaje de bienvenida de Waver">
                        <div class="message-avatar">
                            <svg class="avatar-svg" width="32" height="32" viewBox="0 0 100 100" aria-label="Avatar de Waver">
                                <!-- Avatar SVG aquí -->
                            </svg>
                        </div>
                        <div class="message-content-wrapper">
                            <div class="message-header">
                                <div class="message-author">Waver</div>
                            </div>
                            <div class="message bot-message">
                                <div class="message-text">
                                    Hola, soy Waver, tu agente de e-commerce. Estoy aquí para ayudarte con:
                                    <ul class="feature-list">
                                        <li>Consultas sobre el estado de tus pedidos</li>
                                        <li>Información detallada de productos</li>
                                        <li>Políticas de devolución y garantía</li>
                                        <li>Soporte técnico especializado</li>
                                    </ul>
                                    ¿En qué puedo asistirte hoy?
                                </div>
                            </div>
                            <div class="message-time" id="initialTime"></div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator" style="display: none;" aria-live="polite" aria-label="Waver está escribiendo">
                    <div class="typing-avatar">
                        <svg class="avatar-svg thinking" width="32" height="32" viewBox="0 0 100 100" aria-hidden="true">
                            <!-- Avatar pensando -->
                        </svg>
                    </div>
                    <div class="typing-content">
                        <span>Waver está escribiendo</span>
                        <div class="typing-dots" aria-hidden="true">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>

                <!-- Scroll to Bottom Button -->
                <button class="scroll-to-bottom" id="scrollToBottomBtn" aria-label="Desplazarse al final de la conversación" title="Ir al final">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M7 13L12 18L17 13M7 6L12 11L17 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>

                <!-- Input Area -->
                <div class="chat-input-wrapper" role="region" aria-label="Enviar mensaje">
                    <form id="chatForm" class="chat-form">
                        <div class="input-container">
                            <label for="messageInput" class="sr-only">Mensaje para Waver</label>
                            <input 
                                type="text" 
                                id="messageInput" 
                                class="message-input" 
                                placeholder="Escribe tu mensaje..."
                                maxlength="500"
                                autocomplete="off"
                                aria-describedby="charCounter"
                                aria-label="Escribe tu mensaje para Waver"
                            >
                            <div class="input-actions">
                                <span class="char-counter" id="charCounter" aria-live="polite">0/500</span>
                                <button type="submit" class="send-button" id="sendButton" aria-label="Enviar mensaje">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="send-icon" aria-hidden="true">
                                        <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="loading-icon" style="display: none;" aria-hidden="true">
                                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-dasharray="60" stroke-dashoffset="60">
                                            <animate attributeName="stroke-dashoffset" dur="1s" repeatCount="indefinite" from="60" to="0"/>
                                        </circle>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="historyModalTitle">Historial de Conversaciones</h2>
                <button class="modal-close" id="closeModal" aria-label="Cerrar historial">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="historyContent" role="region" aria-label="Contenido del historial">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/waver-avatar.js?v={{ v }}"></script>
    <script src="/static/js/chat.js?v={{ v }}"></script>
        <script>
            // Diagnóstico: confirma la versión de assets usada en esta carga
            window.__ASSET_V__ = '{{ v }}';
            console.log('Waver assets version =', window.__ASSET_V__);
        </script>
    
    <!-- Token Metrics Status Bar del index.html -->
    <div class="token-metrics hidden" id="tokenMetrics">
        <div class="token-metrics-content">
            <div class="metric-model">
                <span>Waver</span>
            </div>
            <span class="metric-separator">|</span>
            <div class="metric-item">
                <span class="metric-value" id="tokensPerSec">0</span>
                <span class="metric-label">tok/sec</span>
            </div>
            <span class="metric-separator">|</span>
            <div class="metric-item">
                <span class="metric-value" id="totalTokens">0</span>
                <span class="metric-label">tokens</span>
            </div>
            <span class="metric-separator">|</span>
            <div class="metric-item">
                <span class="metric-label">Time:</span>
                <span class="metric-value" id="executionTime">0.0s</span>
            </div>
        </div>
    </div>
    
    <!-- Script inline para configuración inicial -->
    <script>
        // Configuración inicial
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar información del navegador en consola
            console.log('Chatbot E-commerce iniciado');
            console.log('Navegador:', navigator.userAgent);
            console.log('Pantalla:', window.screen.width + 'x' + window.screen.height);
            
            // Verificar soporte de funcionalidades
            if ('localStorage' in window) {
                console.log('✅ LocalStorage soportado');
            } else {
                console.warn('⚠️ LocalStorage no soportado');
            }
            
            if ('fetch' in window) {
                console.log('✅ Fetch API soportado');
            } else {
                console.warn('⚠️ Fetch API no soportado');
            }
            
            // Auto-test de conectividad después de 2 segundos
            setTimeout(() => {
                if (typeof ChatbotUtils !== 'undefined') {
                    ChatbotUtils.testAPI().then(result => {
                        if (result) {
                            console.log('✅ Conectividad con API verificada');
                        } else {
                            console.warn('⚠️ Problema de conectividad con API');
                        }
                    });
                }
            }, 2000);
        });
        
        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('❌ Error en la aplicación:', e.error);
        });
        
        // Manejo de errores de promesas no capturadas
        window.addEventListener('unhandledrejection', function(e) {
            console.error('❌ Promesa rechazada no manejada:', e.reason);
        });
    </script>
</body>
</html>